<div class="p-4 md:p-6 h-full flex flex-col">
    <h1 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-200">Hydration Tracking</h1>

    @if (isLoading()) {
    <p class="text-gray-500">Loading your hydration data...</p>
    } @else if (error()) {
    <div class="text-red-500 bg-red-100 dark:bg-red-900/20 dark:text-red-400 p-4 rounded-md">
        <p><strong>Error:</strong> {{ error() }}</p>
    </div>
    } @else {
    <div class="flex flex-col flex-grow min-h-0">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <app-goal-progress-card title="Today's Intake" [value]="todaysIntake()" [goal]="hydrationGoal()" [unit]="'ml'"
                [icon]="'glass-water'">
            </app-goal-progress-card>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">
                    {{ activeFilter() | titlecase }} Average
                </h3>
                <div class="flex items-baseline space-x-2 mt-2">
                    <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ periodAverage() | number }}</p>
                    <span class="text-lg text-gray-600 dark:text-gray-300">ml / day</span>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex items-center space-x-1 p-1 bg-gray-200 dark:bg-gray-800 rounded-lg self-start mb-4">
                <button (click)="setFilter('day')" [class.active-filter]="activeFilter() === 'day'"
                    class="filter-btn">Day</button>
                <button (click)="setFilter('week')" [class.active-filter]="activeFilter() === 'week'"
                    class="filter-btn">Week</button>
                <button (click)="setFilter('month')" [class.active-filter]="activeFilter() === 'month'"
                    class="filter-btn">Month</button>
            </div>

            @if (activeFilter() === 'month') {
            <div class="mt-4">
                <div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 dark:text-gray-400">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div class="grid grid-cols-7 mt-2">
                    @for (day of calendarData(); track day.date) {
                    <div class="flex justify-center items-center py-1">
                        <div (click)="day.isCurrentMonth && selectDate(day.date)"
                            class="relative w-10 h-10 flex items-center justify-center rounded-full transition-colors duration-200"
                            [class.cursor-pointer]="day.isCurrentMonth"
                            [class.hover:bg-gray-100]="day.isCurrentMonth && day.intake > 0"
                            [class.dark:hover:bg-gray-700/50]="day.isCurrentMonth && day.intake > 0"
                            [class.hover:bg-blue-50]="day.isCurrentMonth && day.intake === 0"
                            [class.dark:hover:bg-gray-700]="day.isCurrentMonth && day.intake === 0">

                            <div class="absolute bottom-0 w-full rounded-full transition-all duration-300"
                                [class.bg-blue-400]="day.isCurrentMonth" [class.dark:bg-blue-600]="day.isCurrentMonth"
                                [class.bg-gray-200]="!day.isCurrentMonth" [class.dark:bg-gray-700]="!day.isCurrentMonth"
                                [style.height.%]="day.fillPercentage"></div>

                            <span class="relative font-medium z-10"
                                [class.text-white]="day.fillPercentage > 50 && day.isCurrentMonth"
                                [class.text-gray-800]="day.fillPercentage <= 50 && day.isCurrentMonth"
                                [class.dark:text-gray-100]="day.fillPercentage <= 50 && day.isCurrentMonth"
                                [class.text-gray-400]="!day.isCurrentMonth"
                                [class.dark:text-gray-500]="!day.isCurrentMonth">
                                {{ day.dayOfMonth }}
                            </span>
                        </div>
                    </div>
                    }
                </div>
            </div>
            } @else {
            <div class="relative h-64 md:h-72">
                <canvas baseChart [data]="barChartData()" [options]="barChartOptions" [type]="'bar'"></canvas>
            </div>

            @if (activeFilter() === 'day') {
            <div class="mt-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">Entries Today</h4>
                @if (dayEntries().length > 0) {
                <ul class="divide-y divide-gray-200 dark:divide-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
                    @for (entry of dayEntries(); track entry._id) {
                    <li class="flex items-center justify-between px-4 py-3">
                        <span class="text-sm text-gray-600 dark:text-gray-400">{{ entry.createdAt | date: 'HH:mm' }}</span>
                        <span class="text-base font-semibold text-gray-800 dark:text-gray-200">{{ entry.volumeInMl | number }} ml</span>
                    </li>
                    }
                </ul>
                } @else {
                <p class="text-sm text-gray-500 dark:text-gray-400">No entries for this day.</p>
                }
            </div>
            }
            }
        </div>

        <div class="mt-12 flex flex-col">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 dark:text-gray-300">Hydration Log</h2>
            <div class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                @for (day of dailySummaryLog(); track day.date) {
                <div
                    class="flex justify-between items-center p-5 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                    <span class="text-base font-medium text-gray-600 dark:text-gray-400">
                        {{ day.date | date: 'EEEE, MMM d' }}
                    </span>
                    <span class="text-lg font-bold text-gray-800 dark:text-gray-200">
                        {{ day.totalVolume | number }} ml
                    </span>
                </div>
                } @empty {
                <p class="text-gray-500 pt-8 text-center text-lg">No data for this period.</p>
                }
            </div>
        </div>
    </div>
    }
</div>